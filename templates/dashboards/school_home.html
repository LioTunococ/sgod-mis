{% load static %}
{% load dashboard_filters %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>School Portal</title>
    <link rel="stylesheet" href="{% static 'css/app.css' %}">
    <link rel="stylesheet" href="{% static 'css/school_home.css' %}">
  </head>
  <body class="container">
    {% include "includes/top_nav.html" %}
    <a href="#main" class="skip-link">Skip to content</a>

    {% if not school_portal %}
      <div class="card card--wide" style="margin-top: 2rem; text-align: center; padding: 3rem;">
        <h1 style="color: #dc2626; margin-bottom: 1rem;">Access Denied</h1>
        <p style="font-size: 1.125rem; color: #6b7280; margin-bottom: 1.5rem;">
          No school portal data available for this account.
        </p>
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem;">
          <p style="color: #991b1b; margin-bottom: 0.5rem;"><strong>Possible reasons:</strong></p>
          <ul style="text-align: left; color: #991b1b; display: inline-block;">
            <li>Your user account is not linked to a school</li>
            <li>You don't have School Head permissions</li>
            <li>Your school assignment is missing in the database</li>
          </ul>
        </div>
        <p style="color: #6b7280;">
          Please contact your SGOD administrator to assign you to a school.
        </p>
      </div>
    {% else %}

    <!-- Page Layout: Sidebar + Main -->
    <div class="portal-layout">
      <aside class="portal-sidebar" aria-label="Sections">
        <div class="portal-sidebar__header">
          <h1 class="portal-sidebar__title">{{ school_portal.school.name }}</h1>
          <div class="portal-hero__meta">
            <span class="muted"><strong>Code:</strong> {{ school_portal.school.code }}</span>
            {% if school_portal.school.district %}
              <span class="muted">&middot;</span>
              <span class="muted"><strong>District:</strong> {{ school_portal.school.district.name }}</span>
            {% endif %}
          </div>
          <div class="portal-sidebar__actions">
            <a href="{% url 'organizations:edit_my_school_profile' %}" class="btn btn--secondary btn--sm">Update School Profile</a>
          </div>
        </div>

        {% if section_cards %}
          <nav class="section-rail" role="navigation">
            <div class="section-rail__label">Units</div>
            <ul class="section-rail__list">
              {% for card in section_cards %}
                <li>
                    <button type="button"
                          class="rail-link {% if card.section.code == selected_section_code or not selected_section_code and forloop.first %}active{% endif %}"
                      aria-current="{% if card.section.code == selected_section_code or not selected_section_code and forloop.first %}page{% endif %}"
                      aria-controls="section-{{ card.section.code }}"
                      data-section-code="{{ card.section.code }}"
                          onclick="selectSection('{{ card.section.code }}', event)">
                    <span class="rail-link__code">{{ card.section.code|upper }}</span>
                    <span class="rail-link__badges">
                      {% if card.drafts_count > 0 %}
                        <span class="tab-badge">{{ card.drafts_count }}</span>
                      {% endif %}
                      {% if card.submitted_pending_count and card.submitted_pending_count > 0 %}
                        <span class="tab-badge" style="background:#f59e0b">{{ card.submitted_pending_count }}</span>
                      {% endif %}
                      {% if card.noted_count and card.noted_count > 0 %}
                        <span class="tab-badge" style="background:#16a34a">{{ card.noted_count }}</span>
                      {% endif %}
                      {% if card.open_count > 0 %}
                        <span class="tab-badge">{{ card.open_count }}</span>
                      {% endif %}
                    </span>
                  </button>
                </li>
              {% endfor %}
            </ul>
          </nav>
        {% endif %}

        <div class="portal-sidebar__summary">
          <div class="summary-chip">
            <span>In Progress</span>
            <strong>{{ school_portal.summary.total_in_progress }}</strong>
          </div>
          <div class="summary-chip">
            <span>Submitted/Noted</span>
            <strong>{{ school_portal.summary.total_submitted }}</strong>
          </div>
          <div class="summary-chip {% if school_portal.summary.returns > 0 %}summary-chip--alert{% endif %}">
            <span>Returns</span>
            <strong>{{ school_portal.summary.returns }}</strong>
          </div>
          <div class="summary-chip">
            <span>Open Forms</span>
            <strong>{{ school_portal.summary.open_forms }}</strong>
          </div>
        </div>
      </aside>

      <main class="portal-main" id="main">
        <!-- Page Intro / Alerts -->
        {% if school_portal.profile_prompt %}
          <div class="portal-hero__prompt" role="status">
            <span aria-hidden="true">âš </span>
            <span>{{ school_portal.profile_prompt }}</span>
          </div>
        {% endif %}

        {% if section_cards %}
        <section class="card" style="margin-bottom: 1.5rem;">
          <div class="section-intro">
            <h2>Form Submissions by Unit</h2>
            <p class="muted">Manage your forms across all government units</p>
          </div>

      <!-- Section Content Panels -->
      {% for card in section_cards %}
        <div 
          class="section-content" 
          id="section-{{ card.section.code }}"
          {% if card.section.code != selected_section_code and not forloop.first or selected_section_code and card.section.code != selected_section_code %}style="display: none;"{% endif %}>
          
          <div class="section-header">
            <h3 class="section-title">
              {{ card.section.name }}
            </h3>
            <p class="muted section-subtitle">
              Manage your {{ card.section.code|upper }} submissions
            </p>
          </div>
          

          <!-- In Progress Forms for this Section -->
          {% if card.drafts_count > 0 %}
            <div style="margin-bottom: 2rem;">
              <h3 class="section-title" style="font-size: 1rem;">
                In Progress ({{ card.drafts_count }})
              </h3>
              <div class="list-vstack">
                {% for draft in card.drafts %}
                  <div class="item-card item-card--progress">
                    <div style="flex: 1;">
                      <div class="item-title">
                        {{ draft.submission.form_template.title }}
                      </div>
                      <div class="item-meta">
                        {% if draft.submission.period %}{{ draft.submission.period.label }}{% endif %}
                        {% if draft.progress > 0 %}
                          &middot; {{ draft.progress }}% complete
                        {% endif %}
                      </div>
                      {% if draft.submission.status == 'returned' %}
                        <div class="item-note-return">
                          <strong>Returned for revision:</strong> {{ draft.submission.returned_remarks|truncatewords:20 }}
                        </div>
                      {% endif %}
                    </div>
                    <div>
                      <a href="{% url 'edit_submission' draft.submission.id %}" class="btn btn--primary btn--sm">
                        {% if draft.submission.status == 'returned' %}Review{% else %}Continue{% endif %}
                      </a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          <!-- Submitted/Noted for this Section -->
          {% if card.submitted_count and card.submitted_count > 0 %}
            <div style="margin-bottom: 2rem;">
              <h3 class="section-title" style="font-size: 1rem;">
                Submitted ({{ card.submitted_count }})
              </h3>
              <div class="list-vstack">
                {% for s in card.submitted %}
                  {% if s.status == 'noted' %}
                    <div class="item-card item-card--noted">
                      <div style="flex: 1;">
                        <div class="item-title" style="display:flex; align-items:center; gap:0.5rem;">
                          {{ s.form_template.title }}
                          <span class="status-pill status-pill--{{ s.status }}">{{ s.get_status_display }}</span>
                        </div>
                        <div class="item-meta">
                          {% if s.period %}{{ s.period.label }}{% endif %}
                          {% if s.submitted_at %}&middot; Submitted {{ s.submitted_at|date:"M d, Y" }}{% endif %}
                        </div>
                        {% if s.noted_remarks %}
                          <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f0fdf4; border-left: 3px solid #16a34a; font-size: 0.875rem; color: #166534;">
                            <strong>Section remarks:</strong> {{ s.noted_remarks|truncatewords:30 }}
                          </div>
                        {% endif %}
                      </div>
                      <div>
                        <a href="{% url 'edit_submission' s.id %}" class="btn btn--secondary btn--sm">View</a>
                      </div>
                    </div>
                  {% else %}
                    <div class="item-card item-card--pending">
                      <div style="flex: 1;">
                        <div class="item-title" style="display:flex; align-items:center; gap:0.5rem;">
                          {{ s.form_template.title }}
                          <span class="status-pill status-pill--{{ s.status }}">{{ s.get_status_display }}</span>
                        </div>
                        <div class="item-meta">
                          {% if s.period %}{{ s.period.label }}{% endif %}
                          {% if s.submitted_at %}&middot; Submitted {{ s.submitted_at|date:"M d, Y" }}{% endif %}
                        </div>
                        <div class="item-pending-note">
                          Awaiting review by {{ card.section.name }}.
                        </div>
                      </div>
                      <div>
                        <a href="{% url 'edit_submission' s.id %}" class="btn btn--secondary btn--sm">View</a>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}

          <!-- Available Forms for this Section -->
          {% if card.open_count > 0 %}
            <div>
              <h3 class="section-title" style="font-size: 1rem; margin-bottom: 1rem;">
                Available Forms ({{ card.open_count }})
              </h3>
              <div class="forms-grid">
                {% for form_info in card.available_forms %}
                  <div class="form-card">
                    <div class="form-card__title">{{ form_info.form_template.title }}</div>
                    <div class="form-card__meta">Due: {{ form_info.deadline|date:"M d, Y" }}</div>
                    {% if form_info.period %}
                      <a href="{% url 'start_submission' form_info.form_template.code form_info.period.id %}" class="btn btn--secondary btn--sm btn--block">Start Form</a>
                    {% else %}
                      <span class="btn btn--secondary btn--sm btn--block" style="opacity: 0.5; cursor: not-allowed;">No Period Available</span>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          <!-- Empty State -->
          {% if card.drafts_count == 0 and card.open_count == 0 %}
            <div class="empty-pane">
              <div class="empty-pane__title">No forms available</div>
              <div class="empty-pane__subtitle">
                There are currently no {{ card.section.code|upper }} forms to submit
              </div>
            </div>
          {% endif %}

        

        </div>
      {% endfor %}

        </section>
        {% endif %}
      </main>
    </div>

    <!-- JavaScript for Tab Switching -->
    <script>
    function selectSection(sectionCode, evt) {
      // Hide all section contents
      document.querySelectorAll('.section-content').forEach(el => el.style.display = 'none');
      
      // Show selected section
      const selectedSection = document.getElementById('section-' + sectionCode);
      if (selectedSection) {
        selectedSection.style.display = 'block';
      }
      
      // Update rail link active states (sidebar)
      document.querySelectorAll('.rail-link').forEach(link => link.classList.remove('active'));
      const linkBtn = (evt && evt.currentTarget) ? evt.currentTarget : document.querySelector('.rail-link');
      if (linkBtn) {
        linkBtn.classList.add('active');
        linkBtn.setAttribute('aria-current', 'page');
      }
      
      // Update URL without reload
      const url = new URL(window.location);
      url.searchParams.set('section', sectionCode);
      window.history.pushState({}, '', url);

      // Persist section preference for quick return
      try { localStorage.setItem('school_portal_section', sectionCode); } catch (e) {}
    }

    // Add hover effects
    document.addEventListener('DOMContentLoaded', function() {
      // Keyboard navigation for sidebar rail
      document.querySelectorAll('.rail-link').forEach((btn, idx, all) => {
        btn.addEventListener('keydown', (e) => {
          const prev = all[Math.max(0, idx - 1)];
          const next = all[Math.min(all.length - 1, idx + 1)];
          if (e.key === 'ArrowUp' && prev) { e.preventDefault(); prev.focus(); }
          if (e.key === 'ArrowDown' && next) { e.preventDefault(); next.focus(); }
          if ((e.key === 'Enter' || e.key === ' ') && btn.dataset.sectionCode) {
            e.preventDefault();
            selectSection(btn.dataset.sectionCode, { currentTarget: btn });
          }
        });
      });

      // Restore last section if URL has none
      const url = new URL(window.location);
      if (!url.searchParams.get('section')) {
        try {
          const saved = localStorage.getItem('school_portal_section');
          if (saved) {
            const btn = document.querySelector(`.rail-link[data-section-code="${saved}"]`);
            if (btn) { selectSection(saved, { currentTarget: btn }); }
          }
        } catch (e) {}
      }
    });
    </script>

    <!-- Section Overview (Legacy - Now Hidden, replaced by tabs above) -->
    {% if false %}  {# Disabled - replaced by tabbed interface #}
    {% if section_cards %}
      <section class="card">
        <h2>Your Forms</h2>
        <p class="muted">Forms in progress and available to start, organized by section</p>

        <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem;">
          {% for card in section_cards %}
            {% include "dashboards/_integrated_section_card.html" with card=card %}
          {% endfor %}
        </div>
      </section>
    {% endif %}
    {% endif %}  {# Close the {% if false %} #}

    <!-- Action Items (Outstanding Returns) -->
    {% if school_portal.outstanding_returns %}
      <section class="card">
        <h2>Outstanding Returns</h2>
        <ul class="portal-list portal-list--stacked">
          {% for submission in school_portal.outstanding_returns %}
            <li class="portal-list__item">
              <div>
                <div class="portal-list__title">{{ submission.form_template.title }}</div>
                <div class="portal-list__meta">
                  <span class="status-pill status-pill--{{ submission.status }}">{{ submission.get_status_display }}</span>
                  {% if submission.period %}
                    &nbsp;&middot;&nbsp;{{ submission.period.label }}
                  {% endif %}
                  &nbsp;&middot;&nbsp;Updated {{ submission.updated_at|date:"M j, Y g:i a" }}
                </div>
                {% if submission.returned_remarks %}
                  <p class="portal-list__remarks">{{ submission.returned_remarks|linebreaksbr }}</p>
                {% endif %}
              </div>
              <div class="portal-list__actions">
                <a class="btn btn--secondary btn--sm" href="{% url 'edit_submission' submission.id %}">Review &amp; resubmit</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      </section>
    {% endif %}

    <!-- Reviewer Tools (if applicable) -->
    {% if show_reviewer_dashboards %}
      <section class="card">
        <h2>Reviewer Tools</h2>
        <div class="portal-hero__quick">
          <a href="{{ district_dashboard_url }}" class="btn btn--ghost btn--sm">Submission Gaps</a>
          <a href="{{ smme_dashboard_url }}" class="btn btn--ghost btn--sm">SMME KPI</a>
          {% if first_section_code %}
            <a href="{% url 'review_queue' first_section_code %}" class="btn btn--ghost btn--sm">Review Queue</a>
          {% endif %}
        </div>
      </section>
    {% endif %}

    {% endif %}  {# Close the school_portal check #}
  </body>
</html>
