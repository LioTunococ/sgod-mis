{% load static %}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SGOD Directory</title>
    <link rel="stylesheet" href="{% static 'css/form-system.css' %}">
  </head>
  <body class="container">
    {% include "includes/auth_nav.html" %}
    <h1>School & User Directory</h1>
    <p class="muted">Create schools and reset user passwords without leaving the dashboard.</p>

    {% include "includes/role_flag_badges.html" %}

    {% if messages %}
      <ul class="alert-list" style="margin-bottom:1.5rem;">
        {% for message in messages %}
          <li class="alert-chip">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <!-- Tab Navigation -->
    <div class="tab-nav" style="margin: 2rem 0; border-bottom: 2px solid #e5e7eb;">
      <button class="tab-btn active" onclick="showTab('schools', event)">
        ðŸ“š Schools
      </button>
      <button class="tab-btn" onclick="showTab('users', event)">
        ðŸ‘¥ Users
      </button>
      <button class="tab-btn" onclick="showTab('sections', event)">
        ðŸ“‹ Sections
      </button>
      <button class="tab-btn" onclick="showTab('periods', event)">
        ðŸ“… Periods
      </button>
    </div>

    <style>
    .tab-nav {
      display: flex;
      gap: 0.5rem;
    }
    .tab-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      background: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 500;
      color: #6b7280;
      transition: all 0.2s;
      font-size: 1rem;
    }
    .tab-btn:hover {
      color: #1f2937;
      background: #f9fafb;
    }
    .tab-btn.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
      font-weight: 600;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    </style>

    <!-- SCHOOLS TAB -->
    <div id="tab-schools" class="tab-content active">
    <section class="card card--wide" style="margin-bottom:1.5rem;">
      <h2>Create School</h2>
      <form method="post" class="form-grid">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_school">
        
        <div class="form-group">
          <label for="id_code" class="form-label">School Code <span class="required">*</span></label>
          {{ school_form.code }}
          {% if school_form.code.errors %}
            <span class="form-error">{{ school_form.code.errors.0 }}</span>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label for="id_name" class="form-label">School Name <span class="required">*</span></label>
          {{ school_form.name }}
          {% if school_form.name.errors %}
            <span class="form-error">{{ school_form.name.errors.0 }}</span>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label for="id_division" class="form-label">Division</label>
          {{ school_form.division }}
        </div>
        
        <div class="form-group">
          <label for="id_district" class="form-label">District</label>
          {{ school_form.district }}
        </div>
        
        <div class="form-group">
          <label for="id_school_type" class="form-label">School Type</label>
          {{ school_form.school_type }}
        </div>
        
        <div class="form-group">
          <label for="id_min_grade" class="form-label">Min Grade</label>
          {{ school_form.min_grade }}
        </div>
        
        <div class="form-group">
          <label for="id_max_grade" class="form-label">Max Grade</label>
          {{ school_form.max_grade }}
        </div>
        
        <div class="form-group">
          <label class="form-label">
            {{ school_form.implements_adm }}
            Implements ADM
          </label>
        </div>
        
        <!-- User Creation Section -->
        <div class="form-group" style="grid-column: 1 / -1; border-top: 2px solid #e5e7eb; padding-top: 1.5rem; margin-top: 1rem;">
          <label class="form-label" style="font-size: 1rem; font-weight: 600; color: #111827;">
            {{ school_form.create_user }}
            Create School Head User Account
          </label>
          <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">
            âœ“ Automatically creates user and assigns <strong>School Head</strong> role for this school
          </p>
        </div>
        
        <div class="form-group">
          <label for="id_username" class="form-label">Username <span class="required">*</span></label>
          {{ school_form.username }}
          {% if school_form.username.errors %}
            <span class="form-error">{{ school_form.username.errors.0 }}</span>
          {% endif %}
          <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">Login username for the school head</p>
        </div>
        
        <div class="form-group">
          <label for="id_user_password" class="form-label">Initial Password <span class="required">*</span></label>
          {{ school_form.user_password }}
          {% if school_form.user_password.errors %}
            <span class="form-error">{{ school_form.user_password.errors.0 }}</span>
          {% endif %}
          <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">Minimum 8 characters</p>
        </div>
        
        <div class="form-group" style="grid-column: 1 / -1;">
          <label for="id_user_email" class="form-label">Email (Optional)</label>
          {{ school_form.user_email }}
          {% if school_form.user_email.errors %}
            <span class="form-error">{{ school_form.user_email.errors.0 }}</span>
          {% endif %}
        </div>
        
        <!-- Role Selection -->
        <div class="form-group" style="grid-column: 1 / -1; border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 0.5rem;">
          <label for="id_user_role" class="form-label">User Role <span class="required">*</span></label>
          {{ school_form.user_role }}
          {% if school_form.user_role.errors %}
            <span class="form-error">{{ school_form.user_role.errors.0 }}</span>
          {% endif %}
          <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">{{ school_form.user_role.help_text }}</p>
        </div>
        
        <!-- Section Assignment (for Section Admins) -->
        <div class="form-group" id="section-assignment-field" style="grid-column: 1 / -1; display: none;">
          <label class="form-label">Assign to Sections <span class="required">*</span></label>
          <p class="muted" style="font-size: 0.875rem; margin-bottom: 0.75rem;">
            Select which sections this Section Admin can manage
          </p>
          {% if school_form.assigned_sections.errors %}
            <span class="form-error" style="display: block; margin-bottom: 0.5rem;">{{ school_form.assigned_sections.errors.0 }}</span>
          {% endif %}
          <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
            {% for section in school_form.assigned_sections.field.queryset %}
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                <input 
                  type="checkbox" 
                  name="assigned_sections" 
                  value="{{ section.id }}"
                  id="section_{{ section.code }}"
                  style="width: 1rem; height: 1rem; cursor: pointer;">
                <span style="font-weight: 600; color: #1f2937;">{{ section.code|upper }}</span>
                <span style="color: #6b7280; font-size: 0.875rem;">- {{ section.name }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
        
        <!-- PSDS District (for PSDS) -->
        <div class="form-group" id="psds-district-field" style="grid-column: 1 / -1; display: none;">
          <label for="id_psds_district" class="form-label">PSDS District <span class="required">*</span></label>
          {{ school_form.psds_district }}
          {% if school_form.psds_district.errors %}
            <span class="form-error">{{ school_form.psds_district.errors.0 }}</span>
          {% endif %}
          <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">{{ school_form.psds_district.help_text }}</p>
        </div>
        
        <script>
        // Show/hide fields based on role selection
        document.addEventListener('DOMContentLoaded', function() {
          const roleSelect = document.querySelector('[name="user_role"]');
          const sectionAssignmentField = document.getElementById('section-assignment-field');
          const psdsDistrictField = document.getElementById('psds-district-field');
          
          function updateFieldsVisibility() {
            const role = roleSelect.value;
            // Show section assignment ONLY for section_admin
            sectionAssignmentField.style.display = role === 'section_admin' ? 'block' : 'none';
            // Show PSDS district ONLY for psds
            psdsDistrictField.style.display = role === 'psds' ? 'block' : 'none';
          }
          
          roleSelect.addEventListener('change', updateFieldsVisibility);
          updateFieldsVisibility(); // Initial state
        });
        </script>
        
        <div class="form-actions">
          <button type="submit" class="btn btn--primary">Create School</button>
        </div>
      </form>
    </section>

    <section class="card card--wide" style="margin-bottom:1.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">Recent Schools</h2>
        <form method="get" style="display: flex; gap: 0.5rem;">
          <input 
            type="text" 
            name="search" 
            class="form-input" 
            placeholder="Search schools..." 
            value="{{ search_query|default:'' }}"
            style="min-width: 250px;"
          >
          <button type="submit" class="btn btn--primary">Search</button>
          {% if search_query %}
            <a href="{% url 'organizations:manage_directory' %}" class="btn btn--outline">Clear</a>
          {% endif %}
        </form>
      </div>
      <div class="table-scroll">
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Code</th>
              <th>District</th>
              <th>Type</th>
              <th>Grades</th>
              <th>ADM</th>
            </tr>
          </thead>
          <tbody>
            {% for school in schools %}
              <tr>
                <td><strong>{{ school.name }}</strong></td>
                <td><code>{{ school.code }}</code></td>
                <td>{{ school.district.name|default:"-" }}</td>
                <td>{{ school.school_type|default:"-" }}</td>
                <td>
                  {% if school.min_grade is not None and school.max_grade is not None %}
                    G{{ school.min_grade }}-G{{ school.max_grade }}
                  {% else %}
                    <span class="muted">Not set</span>
                  {% endif %}
                </td>
                <td>
                  {% if school.implements_adm %}
                    <span style="color: #059669;">âœ“ Yes</span>
                  {% else %}
                    <span class="muted">No</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="muted">
                  {% if search_query %}
                    No schools found matching "{{ search_query }}".
                  {% else %}
                    No schools found.
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="muted" style="margin-top: 1rem; font-size: 0.875rem;">
        Showing {{ schools|length }} most recent school{% if schools|length != 1 %}s{% endif %}
      </p>
    </section>
    </div>
    <!-- END SCHOOLS TAB -->

    <!-- USERS TAB -->
    <div id="tab-users" class="tab-content">
    <section class="card card--wide" style="margin-bottom:1.5rem;">
      <h2>âž• Create New User</h2>
      <p class="muted">Create users with any role (School Head, PSDS, Section Admin, SGOD Admin)</p>
      
      <form method="post" class="form-grid">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_user">
        
        <div class="form-group">
          <label class="form-label">Username <span class="required">*</span></label>
          <input type="text" name="username" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Password <span class="required">*</span></label>
          <input type="password" name="password" class="form-input" required minlength="8">
          <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">Minimum 8 characters</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" name="email" class="form-input">
        </div>
        
        <div class="form-group">
          <label class="form-label">Role <span class="required">*</span></label>
          <select name="user_role" id="user_role_select" class="form-input" required>
            <option value="school_head">School Head</option>
            <option value="psds">PSDS (Provincial Supervisor)</option>
            <option value="section_admin">Section Admin</option>
            <option value="sgod_admin">SGOD Admin</option>
          </select>
        </div>
        
        <!-- School (for School Head) -->
        <div class="form-group" id="school-field" style="grid-column: 1 / -1;">
          <label class="form-label">School <span class="required">*</span></label>
          <select name="school_id" class="form-input">
            <option value="">Select a school</option>
            {% for school in all_schools %}
              <option value="{{ school.id }}">{{ school.name }} ({{ school.code }})</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- District (for PSDS) -->
        <div class="form-group" id="district-field" style="grid-column: 1 / -1; display: none;">
          <label class="form-label">District <span class="required">*</span></label>
          <select name="district_id" class="form-input">
            <option value="">Select a district</option>
            {% for district in districts %}
              <option value="{{ district.id }}">{{ district.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Sections (for Section Admin) -->
        <div class="form-group" id="sections-field" style="grid-column: 1 / -1; display: none;">
          <label class="form-label">Sections <span class="required">*</span></label>
          <div style="display: flex; flex-wrap: wrap; gap: 1rem; padding: 0.75rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
            {% for section in sections %}
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="section_ids" value="{{ section.id }}" style="width: 1rem; height: 1rem; cursor: pointer;">
                <span style="font-weight: 600;">{{ section.code|upper }}</span>
                <span class="muted" style="font-size: 0.875rem;">- {{ section.name }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
        
        <div class="form-actions" style="grid-column: 1 / -1;">
          <button type="submit" class="btn btn--primary">Create User</button>
        </div>
      </form>
      
      <script>
      document.getElementById('user_role_select').addEventListener('change', function() {
        const role = this.value;
        document.getElementById('school-field').style.display = role === 'school_head' ? 'block' : 'none';
        document.getElementById('district-field').style.display = role === 'psds' ? 'block' : 'none';
        document.getElementById('sections-field').style.display = role === 'section_admin' ? 'block' : 'none';
      });
      </script>
    </section>

    <section class="card card--wide" style="margin-bottom:1.5rem;">
      <h2>ðŸ”‘ Reset Password</h2>
      <form method="post" class="form-grid form-grid--compact">
        {% csrf_token %}
        <input type="hidden" name="action" value="reset_password">
        
        <div class="form-group">
          <label for="id_username" class="form-label">Username <span class="required">*</span></label>
          {{ reset_form.username }}
          {% if reset_form.username.errors %}
            <span class="form-error">{{ reset_form.username.errors.0 }}</span>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label for="id_new_password" class="form-label">New Password <span class="required">*</span></label>
          {{ reset_form.new_password }}
          {% if reset_form.new_password.errors %}
            <span class="form-error">{{ reset_form.new_password.errors.0 }}</span>
          {% endif %}
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn--secondary">Reset Password</button>
        </div>
      </form>
    </section>

    <section class="card card--wide">
      <h2>Recent Users</h2>
      <div class="table-scroll">
        <table class="table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>Staff Status</th>
              <th>Last Login</th>
              <th>Date Joined</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              <tr>
                <td><strong>{{ user.username }}</strong></td>
                <td>{{ user.email|default:"-" }}</td>
                <td>
                  {% if user.is_staff %}
                    <span style="color: #059669;">âœ“ Staff</span>
                  {% else %}
                    <span class="muted">Regular</span>
                  {% endif %}
                </td>
                <td>
                  {% if user.last_login %}
                    {{ user.last_login|date:"M d, Y" }}
                  {% else %}
                    <span class="muted">Never</span>
                  {% endif %}
                </td>
                <td>{{ user.date_joined|date:"M d, Y" }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="muted">No users found.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="muted" style="margin-top: 1rem; font-size: 0.875rem;">
        Showing {{ users|length }} most recent user{% if users|length != 1 %}s{% endif %}
      </p>
    </section>
    </div>
    <!-- END USERS TAB -->

    <!-- SECTIONS TAB -->
    <div id="tab-sections" class="tab-content">
    <section class="card card--wide" style="margin-bottom:1.5rem;">
      <h2>Manage Sections</h2>
      <p class="muted" style="margin-bottom: 1.5rem;">Create and manage government office sections (SMME, YFS, HRD, etc.)</p>
      
      <form method="post" class="form-grid form-grid--compact" style="margin-bottom: 2rem;">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_section">
        
        <div class="form-group">
          <label for="section_code" class="form-label">Section Code <span class="required">*</span></label>
          <input 
            type="text" 
            name="section_code" 
            id="section_code"
            class="form-input" 
            placeholder="e.g., smme"
            maxlength="32"
            required
            style="text-transform: lowercase;">
          <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">Lowercase, no spaces (e.g., smme, yfs, hrd)</p>
        </div>
        
        <div class="form-group">
          <label for="section_name" class="form-label">Section Name <span class="required">*</span></label>
          <input 
            type="text" 
            name="section_name" 
            id="section_name"
            class="form-input" 
            placeholder="e.g., School Management, Monitoring and Evaluation Section"
            maxlength="255"
            required>
        </div>
        
        <div class="form-actions" style="grid-column: 1 / -1;">
          <button type="submit" class="btn btn--primary">Create Section</button>
        </div>
      </form>

      <!-- Existing Sections Table -->
      <div style="border-top: 2px solid #e5e7eb; padding-top: 1.5rem;">
        <h3 style="margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">Existing Sections</h3>
        <div class="table-scroll">
          <table class="table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Forms</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for section in sections %}
                <tr>
                  <td><code style="font-weight: 600; font-size: 0.875rem;">{{ section.code|upper }}</code></td>
                  <td><strong>{{ section.name }}</strong></td>
                  <td>
                    <span class="muted">{{ section.form_count }} form{% if section.form_count != 1 %}s{% endif %}</span>
                  </td>
                  <td>
                    <form method="post" style="display: inline;" onsubmit="return confirm('Delete section {{ section.code|upper }}? This will fail if forms are linked to it.');">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_section">
                      <input type="hidden" name="section_id" value="{{ section.id }}">
                      <button type="submit" class="btn btn--sm btn--outline" style="color: #dc2626; border-color: #dc2626;">Delete</button>
                    </form>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="muted">No sections found. Create your first section above.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p class="muted" style="margin-top: 1rem; font-size: 0.875rem;">
          Total: {{ sections|length }} section{% if sections|length != 1 %}s{% endif %}
        </p>
      </div>
    </section>
    </div>
    <!-- END SECTIONS TAB -->

    <!-- PERIODS TAB -->
    <div id="tab-periods" class="tab-content">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
      <!-- LEFT: Quick Create 4 Quarters -->
      <section class="card">
        <h2 style="color: #3b82f6;">ðŸ“… Quick Create: School Year (4 Quarters)</h2>
        <p class="muted" style="margin-bottom: 1.5rem;">Create a school year with all 4 quarters at once: Q1, Q2, Q3, Q4 Reports</p>
        
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_school_year">
          
          <div class="form-group">
            <label class="form-label">School Year Start <span class="required">*</span></label>
            <input 
              type="number" 
              name="sy_start" 
              class="form-input" 
              placeholder="e.g., 2025"
              min="2020"
              max="2050"
              required>
            <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">This will create SY 2025-2026 with Q1, Q2, Q3, Q4 Reports</p>
          </div>
          
          <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e5e7eb;">
          
          <h3 style="font-size: 1rem; margin-bottom: 1rem;">Quarter Deadlines (Optional)</h3>
          
          <!-- Q1 -->
          <div style="margin-bottom: 1rem;">
            <label class="form-label" style="font-weight: 600;">Q1 Report</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; margin-bottom: 0.25rem;">Open Date</label>
                <input type="date" name="q1_open" class="form-input" style="margin: 0;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; margin-bottom: 0.25rem;">Close Date</label>
                <input type="date" name="q1_close" class="form-input" style="margin: 0;">
              </div>
            </div>
          </div>
          
          <!-- Q2 -->
          <div style="margin-bottom: 1rem;">
            <label class="form-label" style="font-weight: 600;">Q2 Report</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; margin-bottom: 0.25rem;">Open Date</label>
                <input type="date" name="q2_open" class="form-input" style="margin: 0;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; margin-bottom: 0.25rem;">Close Date</label>
                <input type="date" name="q2_close" class="form-input" style="margin: 0;">
              </div>
            </div>
          </div>
          
          <!-- Q3 -->
          <div style="margin-bottom: 1rem;">
            <label class="form-label" style="font-weight: 600;">Q3 Report</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; margin-bottom: 0.25rem;">Open Date</label>
                <input type="date" name="q3_open" class="form-input" style="margin: 0;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; margin-bottom: 0.25rem;">Close Date</label>
                <input type="date" name="q3_close" class="form-input" style="margin: 0;">
              </div>
            </div>
          </div>
          
          <!-- Q4 -->
          <div style="margin-bottom: 1.5rem;">
            <label class="form-label" style="font-weight: 600;">Q4 Report</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; margin-bottom: 0.25rem;">Open Date</label>
                <input type="date" name="q4_open" class="form-input" style="margin: 0;">
              </div>
              <div>
                <label style="display: block; font-size: 0.875rem; margin-bottom: 0.25rem;">Close Date</label>
                <input type="date" name="q4_close" class="form-input" style="margin: 0;">
              </div>
            </div>
          </div>
          
          <button type="submit" class="btn btn--primary" style="width: 100%;">
            âž• Create School Year with 4 Quarters
          </button>
        </form>
      </section>

      <!-- RIGHT: Create Single Period -->
      <section class="card">
        <h2 style="color: #10b981;">âž• Create Single Period</h2>
        <p class="muted" style="margin-bottom: 1.5rem;">Create a custom period with flexible label and dates</p>
        
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_period">
          
          <div class="form-group">
            <label class="form-label">School Year Start <span class="required">*</span></label>
            <input 
              type="number" 
              name="sy_start" 
              class="form-input" 
              placeholder="e.g., 2025"
              min="2020"
              max="2050"
              required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Period Label <span class="required">*</span></label>
            <input 
              type="text" 
              name="label" 
              class="form-input" 
              placeholder="e.g., Q1 Report, November Submission"
              required>
            <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">Custom name for this period</p>
          </div>
          
          <div class="form-group">
            <label class="form-label">Quarter Tag (Optional)</label>
            <select name="quarter_tag" class="form-input">
              <option value="">-- No tag (not shown in quarterly charts) --</option>
              <option value="Q1">Q1 - First Quarter</option>
              <option value="Q2">Q2 - Second Quarter</option>
              <option value="Q3">Q3 - Third Quarter</option>
              <option value="Q4">Q4 - Fourth Quarter</option>
              <option value="S1">S1 - First Semester</option>
              <option value="S2">S2 - Second Semester</option>
            </select>
            <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">For filtering and grouping in charts</p>
          </div>
          
          <div class="form-group">
            <label class="form-label">Display Order</label>
            <input 
              type="number" 
              name="display_order" 
              class="form-input" 
              placeholder="1" 
              value="1" 
              min="0">
            <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">Order in dropdowns and charts (1, 2, 3...)</p>
          </div>
          
          <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e5e7eb;">
          
          <h3 style="font-size: 1rem; margin-bottom: 1rem;">Submission Window</h3>
          
          <div class="form-group">
            <label class="form-label">Open Date</label>
            <input type="date" name="open_date" class="form-input">
            <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">When schools can start submitting</p>
          </div>
          
          <div class="form-group">
            <label class="form-label">Close Date</label>
            <input type="date" name="close_date" class="form-input">
            <p class="muted" style="margin-top: 0.25rem; font-size: 0.875rem;">Submission deadline</p>
          </div>
          
          <button type="submit" class="btn btn--primary" style="width: 100%; background: #10b981;">
            âž• Create Period
          </button>
        </form>
      </section>
    </div>

    <!-- Existing Periods Table -->
    <section class="card card--wide">
      <h2>ï¿½ Existing Periods</h2>
      <div class="table-scroll">
        <table class="table">
          <thead>
            <tr>
              <th>School Year</th>
              <th>Label</th>
              <th>Tag</th>
              <th>Order</th>
              <th>Open Date</th>
              <th>Close Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for period in periods %}
              <tr>
                <td><strong>SY {{ period.school_year_start }}-{{ period.school_year_end }}</strong></td>
                <td>{{ period.label }}</td>
                <td>
                  {% if period.quarter_tag %}
                    <code style="font-weight: 600; background: #eff6ff; color: #3b82f6; padding: 0.125rem 0.5rem; border-radius: 0.25rem;">{{ period.quarter_tag }}</code>
                  {% else %}
                    <span class="muted">â€”</span>
                  {% endif %}
                </td>
                <td>{{ period.display_order }}</td>
                <td>
                  {% if period.open_date %}
                    {{ period.open_date|date:"M d, Y" }}
                  {% else %}
                    <span class="muted">Not set</span>
                  {% endif %}
                </td>
                <td>
                  {% if period.close_date %}
                    {{ period.close_date|date:"M d, Y" }}
                  {% else %}
                    <span class="muted">Not set</span>
                  {% endif %}
                </td>
                <td>
                  {% if period.is_active %}
                    {% if period.is_open %}
                      <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #dcfce7; color: #166534; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">Open</span>
                    {% else %}
                      <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #fef3c7; color: #92400e; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">Closed</span>
                    {% endif %}
                  {% else %}
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #f3f4f6; color: #6b7280; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">Inactive</span>
                  {% endif %}
                </td>
                <td>
                  <form method="post" style="display: inline;" onsubmit="return confirm('Delete period {{ period.label }}? This may affect existing submissions.');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_period">
                    <input type="hidden" name="period_id" value="{{ period.id }}">
                    <button type="submit" class="btn btn--sm btn--outline" style="color: #dc2626; border-color: #dc2626;">Delete</button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="8" class="muted">No periods found. Create your first school year or period above.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="muted" style="margin-top: 1rem; font-size: 0.875rem;">
        Total: {{ periods|length }} period{% if periods|length != 1 %}s{% endif %}
      </p>
    </section>
    </div>
    <!-- END PERIODS TAB -->

    <script>
    function showTab(tabName, event) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById('tab-' + tabName).classList.add('active');
      event.target.classList.add('active');
    }
    </script>
  </body>
</html>
